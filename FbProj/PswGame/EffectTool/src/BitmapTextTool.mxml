<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   width="401" height="152">
	<fx:Declarations>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import mx.controls.Alert;
			//位图文本工具，初步功能为将mc序列帧转换成自定义的文件格式，该mc用文字的样式名称命名，
			//每一帧严格保持一致的宽高，如果文字为非数字内容则需要将文字内容写到帧标签中
			//自定义的文件格式为 位图宽度+位图高度+[uinicode(16)+位图数据] 
			
			private var file:File;
			private function onFrameClick():void
			{
				file = new File();
				file.addEventListener(Event.SELECT,onSelect);
				file.browse([new FileFilter("Flash Movie","*.swf")]);
			}
			
			private function onSelect(e:Event):void
			{
				file.removeEventListener(Event.SELECT,onSelect);
				file.addEventListener(Event.COMPLETE,function onComplete(e:Event):void
				{
					var loader:Loader = new Loader();
					var lc:LoaderContext = new LoaderContext();
					lc.allowCodeImport = true;
					loader.contentLoaderInfo.addEventListener(Event.COMPLETE,onLoaderComplete);
					loader.loadBytes(file.data,lc);
				});
				file.load();
			}
			
			private function onLoaderComplete(e:Event):void
			{
				var target:LoaderInfo = e.target as LoaderInfo;
				target.removeEventListener(Event.COMPLETE,onLoaderComplete);
				var swf:MovieClip = target.loader.content as MovieClip;
				while(swf.numChildren)
				{
					var mc:MovieClip = swf.removeChildAt(0) as MovieClip;
					parseMc(mc);
				}
			}
			
			private function parseMc(mc:MovieClip):void
			{
				mc.gotoAndStop(1);
				
				var f:File = new File("E:/physwf-flash-lab/FbProj/PswGame/PswGame_Shell/resource/text/"+mc.name+".swf");
				var fs:FileStream = new FileStream();
				fs.open(f,FileMode.WRITE);
				var bounds:Rectangle = new Rectangle(0,0,mc.width,bounds.height);
				
				var fileData:ByteArray = new ByteArray();
				trace(bounds.left,bounds.top,bounds.width,bounds.height,"w/h");
				bounds.right = uint(bounds.right);
				bounds.bottom = uint(bounds.bottom);
				trace(bounds.width,bounds.height,"w/h 2");
				fileData.writeUnsignedInt(bounds.width);
				fileData.writeUnsignedInt(bounds.height);
				
				var frameNum:uint = mc.totalFrames;
				var unicode:uint;
				for(var i:uint=1;i<=frameNum;++i)
				{
					mc.gotoAndStop(i);
					
					var label:String = mc.currentFrameLabel;
					label ||= String(i-1);
					unicode = label.charCodeAt(0);
					
					var bmd:BitmapData = new BitmapData(bounds.width,bounds.height,true,0);
					bmd.draw(mc);
					var bytes:ByteArray = bmd.getPixels(bmd.rect);
					stage.addChild(new Bitmap(bmd)).x = (i-1) * bounds.width;
					fileData.writeShort(unicode);
					fileData.writeBytes(bytes);
					trace(bounds.width * bounds.height * 4 , bytes.length);
				}
				
				fileData.deflate();
				
				fs.writeBytes(fileData);
				fs.close();
				
				Alert.show("ok","ok",4,null,function():void { exit(); });
				
			}
		]]>
	</fx:Script>
	<s:Button x="295" y="96" label="序列帧" click="onFrameClick()"/>
</s:WindowedApplication>
